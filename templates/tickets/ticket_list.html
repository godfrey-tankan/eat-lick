{% extends 'layouts/base.html' %}
{% load static %}
{% load tz %}

{% block content %}


<style>
  .unique-ticket-popup-form-container {
    display: none; /* Hidden by default */
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    justify-content: center;
    align-items: center;
    z-index: 9999;
  }
  
  .unique-ticket-popup-form-content {
    background-color: white;
    padding: 20px;
    border-radius: 8px;
    max-width: 600px;
    width: 100%;
    position: relative;
  }
  
  .unique-popup-title {
    font-size: 24px;
    font-weight: bold;
    margin-bottom: 20px;
  }
  
  .unique-close-ticket-popup-btn,
  .unique-popup-close-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    font-size: 24px;
    cursor: pointer;
    color: #333;
  }
  
  .unique-form-label {
    font-size: 14px;
    font-weight: bold;
    margin-bottom: 8px;
  }
  
  .unique-form-input,
  .unique-form-textarea,
  .unique-form-select {
    width: 100%;
    padding: 10px;
    margin-bottom: 15px;
    border-radius: 4px;
    border: 1px solid #ccc;
    font-size: 14px;
  }
  
  .unique-form-textarea {
    resize: vertical;
  }
  
  .unique-submit-ticket-btn {
    background-color: #007bff;
    color: white;
    padding: 10px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    width: 100%;
  }
  
  .unique-submit-ticket-btn:hover {
    background-color: #0056b3;
  }
  
  .unique-ticket-popup-form-container.show {
    display: flex;
  }
  </style>
{% comment %} {% if request.user.is_superuser%} {% endcomment %}

<div class="container-fluid py-4">



  <div id="unique-ticket-popup" class="unique-ticket-popup-form-container">
    <div class="unique-ticket-popup-form-content">
      <span class="unique-close-ticket-popup-btn" id="close-ticket-popup-btn">&times;</span>
  
      <h3 class="unique-popup-title">Add New Ticket</h3>
  
      <!-- Ticket Form -->
      <form id="unique-ticket-form" class="unique-ticket-form-container">
        <label for="ticket-title" class="unique-form-label">Title</label>
        <input type="text" id="ticket-title" name="title" class="unique-form-input" placeholder="Ticket Title" required>
  
        <label for="ticket-description" class="unique-form-label">Description</label>
        <textarea id="ticket-description" name="description" class="unique-form-textarea" placeholder="Ticket Description" rows="4" required></textarea>
  
        <label for="ticket-inquirer" class="unique-form-label">Inquirer</label>
        
        <select id="ticket-inquirer" name="created_by" class="unique-form-select" required>
          <!-- Inquirer options will be populated dynamically -->
        </select>

        <label for="ticket-assigned-to" class="unique-form-label">Assigned To</label>
        <select id="ticket-assigned-to" name="assigned_to" class="unique-form-select" required>
          <!-- Support Member options will be populated dynamically -->
        </select>
  
        <label for="ticket-branch" class="unique-form-label">Branch</label>
        <select id="ticket-branch" name="branch_opened" class="unique-form-select" required>
          <!-- Branch options will be populated dynamically -->
        </select>

        <label for="ticket-inquiry-type" class="unique-form-label">Inquiry Type</label>

        <label for="ticket-inquiry-type" class="unique-form-label">Inquiry Type</label>
            <select id="ticket-inquiry-type" name="inquiry_type" class="unique-form-select">
                <option value="technical">Technical Issues</option>
                <option value="sales">Sales</option>
                <option value="billing">Billing Issues</option>
                <option value="account">Account Management</option>
                <option value="feedback">Feedback</option>
                <option value="others">Others</option>
            </select>

        <button type="submit" id="submit-ticket" class="unique-submit-ticket-btn">Add Ticket</button>
      </form>
  
      <span class="unique-popup-close-btn" id="close-ticket-form-btn">&times;</span>
    </div>
</div>


  <div class="row">
    <div class="col-12">
      <div class="card mb-4">
        <div class="card-header pb-0">

          {% if branch%}
          <h6>Branch: 
            <span 
                style='background-color:#fde68a;
                padding:3px;
                border-radius:5px;
                color:#052e16;
                font-weight:bold;
                '
                >{{ branch }} Inquiries</span>
    
            </h6>
          {% elif escalated %}
          <h6>
            <span 
                style='background-color:#fde68a;
                padding:3px;
                border-radius:5px;
                color:#052e16;
                font-weight:bold;
                '
                >Escalated Tickets</span>
    
            </h6>
          {% elif member %}
          <h6>Tickets Assigned to 
            <span 
                style='background-color:#fde68a;
                padding:3px;
                border-radius:5px;
                color:#052e16;
                font-weight:bold;
                '
                >{{ member.username }}</span>
    
            </h6>
          {% elif creator%}
          <h6>Created by: 
            <span 
                style='background-color:#fde68a;
                padding:3px;
                border-radius:5px;
                color:#052e16;
                font-weight:bold;
                '
                >{{ creator }}</span>
                
              </h6>
              {% else %}
              
              <h6>Inquiries Table
              </h6>
              {% endif %}
              <button id="open-ticket-popup-btn" class="btn btn-primary">+ New Ticket</button>

          <form id="field-filter-form">
            
            <label class="me-2">
              <input type="checkbox" name="field" value="opened-by" checked> Opened By
            </label>
            <label class="me-2">
                <input type="checkbox" name="field" value="description" checked> Description
            </label>
            <label class="me-2">
                <input type="checkbox" name="field" value="branch" checked> Branch
            </label>
            <label class="me-2">
                <input type="checkbox" name="field" value="status" checked> Status
            </label>
            <label class="me-2">
                <input type="checkbox" name="field" value="created-at" checked> Created At
              </label>
              <label class="me-2">
                <input type="checkbox" name="field" value="assigned-to" checked> Assigned to
              </label>
            </form>


        </div>
        <div class="card-body px-0 pt-0 pb-2">
          <div class="table-responsive p-0">
            <table class="table align-items-center mb-0">
             
              <thead
              >
                <tr>
                  <th class="text-uppercase  text-xxs font-weight-bolder opacity-7 opened-by">
                    <a href="#" class="">Opened By</a>
                  </th>
                  <th class="text-uppercase  text-xxs font-weight-bolder opacity-7 ps-2 description">
                    <a href="#" class="">Description</a>
                  </th>
                  <th class="text-uppercase  text-xxs font-weight-bolder opacity-7 ps-2 branch">
                    
                    <a href="#" class="">Branch</a>
                  </th>
                  <th class="text-uppercase  text-xxs font-weight-bolder opacity-7 ps-2 status">
                    <a href="#" class="">Status </a>
                  </th>

                  
                  <th class="text-center text-uppercase  text-xxs font-weight-bolder opacity-7 created-at">
                    <a href="?sort=created_at" class="">Created At</a>
                  </th>
                  <th class="text-center text-uppercase  text-xxs font-weight-bolder opacity-7 created-at">
                    <a href="#" class="">Attended At</a>
                  </th>
                  <th class="text-center text-uppercase  text-xxs font-weight-bolder opacity-7 assigned-to">
                    Assigned to
                  </th>
                  <th class="text-center text-uppercase  text-xxs font-weight-bolder opacity-7">
                    <a href="?sort=time_taken" class="">Time Taken</a>
                    <form id="filter-form" method="GET" action="" style="display:inline;">
                      <div style="display: flex; align-items: center;">
                        <input 
                            type="text" 
                            name="filter_time" 
                            placeholder="minutes" 
                            class="text-secondary text-xs font-weight-bold" 
                            id="filter-time-input"
                            style="margin-right: 5px; width: 100px;"
                            value="{{ request.GET.filter_time }}">
                        <select name="operator" id="operator-select" style="margin-right: -200px; width: 80px;background-color:transparent;">
                            <option value="<" {% if request.GET.operator == "<" %}selected{% endif %}><</option>
                            <option value="=" {% if request.GET.operator == "=" %}selected{% endif %}>=</option>
                            <option value=">" {% if request.GET.operator == ">" %}selected{% endif %}>></option>
                            <option value="<=" {% if request.GET.operator == "<=" %}selected{% endif %}><=</option>
                            <option value=">=" {% if request.GET.operator == ">=" %}selected{% endif %}>>=</option>
                        </select>
                      </div>
                    </form>
                  </th>
                </tr>
              </thead>
              <tbody>
                {% for ticket in tickets %}
                <tr>
                    <td class='username-class opened-by'>
                        <div class="d-flex px-2 py-1">
                          <a href="{% url 'ticket_detail' ticket.id %}" class="text-secondary text-xs font-weight-bold">
                            <div class="d-flex flex-column justify-content-center">
                              <h6 class="mb-0 text-sm">{{ ticket.created_by.username|title }}

                                <span class=" start-100 translate-middle p-1 bg-secondary border border-light semi-rounded">
                                  <span class="text-xs " ><span class='ticket-messages'>{{ticket.message_count}}</span> messages</span>
                                </span>
                              </h6>
                            </div>
                          </div>
                        </a>
                    </td>
                    <td class='description'>
                      <a href="{% url 'ticket_detail' ticket.id %}" class="text-xs font-weight-bold">
                      <p class="text-xs font-weight-bold mb-0" title="{{ ticket.description }}">{{ ticket.description|truncatechars:30 }}</p>
                    </a>
                  </td>
                    <td class='branch'>
                      <a href="{% url 'tickets_by_branch' ticket.branch_opened %}" class="text-xs font-weight-bold">
                      <p class="text-xs font-weight-bold mb-0">{{ ticket.branch_opened }}</p>
                    </a>
                  </td>
                    <td class="align-middle text-center status">
                        <a href="{% url 'ticket_list_by_status' ticket.status %}" class="badge badge-sm position-relative" style="background-color: 
                            {% if ticket.status == 'open' %}
                                lightgreen
                            {% elif ticket.status == 'resolved' %}
                                green
                            {% elif ticket.status == 'pending' %}
                                orange
                            {% elif ticket.status == 'closed' %}
                                red
                            {% endif %}
                        ">
                            {{ ticket.status|title }}
                          </a>
                        </td>
                        <td class="align-middle text-center created-at">
                          <span class="text-secondary text-xs font-weight-bold">
                            {{ ticket.created_at|localtime }}
                          </span>
                      </td>
                        <td class="align-middle text-center created-at">
                          <span class="text-secondary text-xs font-weight-bold">{{ ticket.attended_at|localtime }}</span>
                        </td>
                        {% if ticket.assigned_to %}
                        <td class="align-middle text-center assigned-user assigned-to">
                          <a href="{% url 'tickets_by_assignee' ticket.assigned_to.id %}" class="text-xs font-weight-bold">
                            {{ ticket.assigned_to.username }}
                        </a>

                        <a href="{% url 'escalated_tickets' %}" class="escalate-ticket">
                          <i class='bx bxs-up-arrow-square'></i>
                        {% if ticket.is_escalated %}
                          <span class='escaleted-ticket'>escalated</span>
                        {% endif %}
                        </a>
                    </td>
                    {% else %}
                    <td class="align-middle text-center">
                        <span class="text-secondary text-xs font-weight-bold">Unassigned</span>
                    </td>
                    {% endif %}
                    <td class="align-middle text-center">
                      <span class="text-secondary text-xs font-weight-bold">{{ ticket.get_time_to_resolve }}</span>
                    </td>
                </tr>
                {% endfor %}

                


            </tbody>
              {% comment %} <tbody>
                {% for ticket in tickets %}
                <tr class="ticket-row">
                  <td>
                    <div class="d-flex px-2 py-1">
                      <div class="d-flex flex-column justify-content-center">
                        <h6 class="mb-0 text-sm">
                          
                          <a href="{% url 'ticket_detail' ticket.id %}">{{ ticket.created_by.username }}</a>
                        </h6>
                      </div>
                    </div>
                  </td>
                  <td>
                    <p class="text-xs font-weight-bold mb-0">{{ ticket.description }}</p>
                  </td>
                  <td class="align-middle text-center">
                    <span class="text-secondary text-xs font-weight-bold">{{ ticket.created_at|date:"d/m/Y" }}</span>
                  </td>
                  <td class="align-middle text-center">
                    <span class="text-secondary text-xs font-weight-bold">{{ ticket.assigned_to }}</span>
                  </td>
                  <td class="align-middle text-center">
                    <span class="text-secondary text-xs font-weight-bold">{{ ticket.get_time_to_resolve }}</span>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="4" class="text-center">No tickets with status "{{ status }}" found.</td>
                </tr>
                {% endfor %}
              </tbody> {% endcomment %}
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Popup Container -->
<div id="popup" class="popup-overlay">
  <div id="popup-content" class="popup-content">
    <div id="popup-description" class="popup-description"></div>
  </div>
  <span class="close-btn">&times;</span>
</div>
{% comment %} {% else %}
<div class="container-fluid py-4">
  <div class="row">
    <div class="col-12">
      <div class="card mb-4">
        <div class="card-header pb-0">
          <h6>My Inquiries</h6>
        </div>
        <div class="card-body px-0 pt-0 pb-2">
          <div class="table-responsive p-0">
            <table class="table align-items-center mb-0">
              <thead
              style="background-color: #f8f9fe;"
              >
                <tr>
                  <th class="text-uppercase text-black text-xxs font-weight-bolder opacity-7 opened-by">
                    Opened By
                  </th>
                  <th class="text-uppercase text-black text-xxs font-weight-bolder opacity-7 ps-2 description">
                    Description
                  </th>
                  <th class="text-uppercase text-black text-xxs font-weight-bolder opacity-7 ps-2 branch">
                    Branch
                  </th>
                  <th class="text-uppercase text-black text-xxs font-weight-bolder opacity-7 ps-2 status">
                    Status
                  </th>
                  <th class="text-center text-uppercase text-black text-xxs font-weight-bolder opacity-7 created-at">
                    <a href="?sort=created_at" class="text-black">Created At</a>
                  </th>
                  <th class="text-center text-uppercase text-black text-xxs font-weight-bolder opacity-7 assigned-to">
                    Assigned to
                  </th>
                  <th class="text-center text-uppercase text-black text-xxs font-weight-bolder opacity-7">
                    <a href="?sort=time_taken" class="text-black
                    ">Time Taken</a>
                    <form id="filter-form" method="GET" action="" style="display:inline;">
                      <div style="display: flex; align-items: center;">
                        <input 
                            type="text" 
                            name="filter_time" 
                            placeholder="minutes" 
                            class="text-secondary text-xs font-weight-bold" 
                            id="filter-time-input"
                            style="margin-right: 5px; width: 100px;"
                            value="{{ request.GET.filter_time }}">
                        <select name="operator" id="operator-select" style="margin-right: -200px; width: 80px;">
                            <option value="<" {% if request.GET.operator == "<" %}selected{% endif %}><</option>
                            <option value="=" {% if request.GET.operator == "=" %}selected{% endif %}>=</option>
                            <option value=">" {% if request.GET.operator == ">" %}selected{% endif %}>></option>
                            <option value="<=" {% if request.GET.operator == "<=" %}selected{% endif %}><=</option>
                            <option value=">=" {% if request.GET.operator == ">=" %}selected{% endif %}>>=</option>
                        </select>
                      </div>
                    </form>
                  </th>
                </tr>
              </thead>
              <tbody>
                {% for ticket in tickets %}
                <tr>
                    <td class='username-class opened-by'>
                        <div class="d-flex px-2 py-1">
                          <a href="{% url 'ticket_detail' ticket.id %}" class="text-secondary text-xs font-weight-bold">
                            <div class="d-flex flex-column justify-content-center">
                              <h6 class="mb-0 text-sm">{{ ticket.created_by.username|title }}

                                <span class=" start-100 translate-middle p-1 bg-secondary border border-light semi-rounded">
                                  <span class="text-xs " ><span class='ticket-messages'>{{ticket.message_count}}</span> messages</span>
                                </span>
                              </h6>
                            </div>
                          </div>
                        </a>
                    </td>
                    <td class='description'>
                      <a href="{% url 'ticket_detail' ticket.id %}" class="text-xs font-weight-bold">
                      <p class="text-xs font-weight-bold mb-0" title="{{ ticket.description }}">{{ ticket.description|truncatechars:30 }}</p>
                    </a>
                  </td>
                    <td class='branch'>
                      <a href="{% url 'tickets_by_branch' ticket.branch_opened %}" class="text-xs font-weight-bold">
                      <p class="text-xs font-weight-bold mb-0">{{ ticket.branch_opened }}</p>
                    </a>
                  </td>
                    <td class="align-middle text-center status">
                        <a href="{% url 'ticket_list_by_status' ticket.status %}" class="badge badge-sm position-relative" style="background-color: 
                            {% if ticket.status == 'open' %}
                                lightgreen
                            {% elif ticket.status == 'resolved' %}
                                green
                            {% elif ticket.status == 'pending' %}
                                orange
                            {% elif ticket.status == 'closed' %}
                                red
                            {% endif %}
                        ">
                            {{ ticket.status|title }}
                          </a>
                        </td>
                        <td class="align-middle text-center created-at">
                          <span class="text-secondary text-xs font-weight-bold">{{ ticket.created_at }}</span>
                        </td>
                        {% if ticket.assigned_to %}
                        <td class="align-middle text-center assigned-user assigned-to">
                          <a href="{% url 'tickets_by_assignee' ticket.assigned_to.id %}" class=" text-xs font-weight-bold">
                            {{ ticket.assigned_to.username }}
                        </a>
                        <a href="{% url 'escalated_tickets' %}" class="escalate-ticket">
                          <i class='bx bxs-up-arrow-square'></i>
                        {% if ticket.is_escalated %}
                          <span class='escaleted-ticket'>escalated</span>
                        {% endif %}
                        </a>
                    </td>
                    {% else %}
                    <td class="align-middle text-center">
                        <span class="text-secondary text-xs font-weight-bold">Unassigned</span>
                    </td>
                    {% endif %}
                    <td class="align-middle text-center">
                      <span class="text-secondary text-xs font-weight-bold">{{ ticket.get_time_to_resolve }}</span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %} {% endcomment %}

{% block scripts %}


<script>
  document.addEventListener('DOMContentLoaded', function() {
      const checkboxes = document.querySelectorAll('#field-filter-form input[type="checkbox"]');
      
      checkboxes.forEach(function(checkbox) {
          checkbox.addEventListener('change', function() {
              const fieldClass = this.value;
              const isChecked = this.checked;
              
              document.querySelectorAll('.' + fieldClass).forEach(function(element) {
                  if (isChecked) {
                      element.style.display = '';
                  } else {
                      element.style.display = 'none';
                  }
              });
          });
      });
  });
</script>
{% comment %}Add manual Ticket popup form {% endcomment %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Open the Ticket Popup
    document.getElementById('open-ticket-popup-btn').addEventListener('click', function() {
        document.getElementById('unique-ticket-popup').classList.add('show');
    });

    // Close the Ticket Popup
    document.getElementById('close-ticket-popup-btn').addEventListener('click', function() {
        document.getElementById('unique-ticket-popup').classList.remove('show');
    });

    // Close form button inside popup
    document.getElementById('close-ticket-form-btn').addEventListener('click', function() {
        document.getElementById('unique-ticket-popup').classList.remove('show');
    });

    // Get references to DOM elements
    const form = document.getElementById("unique-ticket-form");
    const submitBtn = document.getElementById("submit-ticket");

    // Fetch data for inquirers, support members, and branches on page load
    fetch('/create_ticket/')  // Create an endpoint to serve this data
        .then(response => response.json())
        .then(data => {
            populateSelectOptions('ticket-inquirer', data.inquirers);
            populateSelectOptions('ticket-assigned-to', data.support_members);
            populateSelectOptions('ticket-branch', data.branches);
        })
        .catch(error => console.error('Error fetching ticket data:', error));

    // Function to populate select options dynamically
    function populateSelectOptions(selectId, options) {
        const selectElement = document.getElementById(selectId);

        // Clear existing options before appending new ones
        selectElement.innerHTML = ''; // Clear previous options

        options.forEach(option => {
            const optionElement = document.createElement('option');
            optionElement.value = option.id;
            if (selectId === 'ticket-branch') {
                optionElement.textContent = option.name;
            } else {
                optionElement.textContent = option.username;
            }
            selectElement.appendChild(optionElement);
        });
    }

    // Handle form submission via AJAX
    form.addEventListener("submit", function(event) {
        event.preventDefault(); // Prevent the form from submitting the traditional way

        // Ensure form submission is not triggered again
        if (submitBtn.disabled) {
            return; // Prevent duplicate submission if the button is disabled
        }

        const formData = new FormData(form);
        
        // Show a loading indicator on the submit button
        submitBtn.disabled = true;
        submitBtn.innerHTML = "Creating...";

        fetch("/create_ticket/", {  // Use the correct backend endpoint
            method: "POST",
            body: formData,  // This will include the selected inquirer
        })
        .then(response => response.json())
        .then(data => {
            // Show success message or handle the response
            if (data.success) {
                alert("Ticket created successfully.");
                form.reset();  // Reset the form fields
                document.getElementById('unique-ticket-popup').classList.remove('show');  // Close the popup
            } else {
                alert("There was an error creating the ticket. Please try again.");
            }
        })
        .catch(error => {
            alert("Error submitting the form. Please try again.");
        })
        .finally(() => {
            submitBtn.disabled = false;
            submitBtn.innerHTML = "Add Ticket";  // Restore the button text
        });
    });
});


</script>




<script>
  document.addEventListener('DOMContentLoaded', function() {
      var filterForm = document.getElementById('filter-form');
      var operatorSelect = document.getElementById('operator-select');
      var filterTimeInput = document.getElementById('filter-time-input');
  
      function submitForm() {
          filterForm.submit(); 
      }
      operatorSelect.addEventListener('change', submitForm);
      filterTimeInput.addEventListener('input', function() {
          clearTimeout(this.timeout);
          this.timeout = setTimeout(submitForm, 600); 
      });
      // Popup logic
      var popup = document.getElementById('popup');
      var popupContent = document.getElementById('popup-content');
      var closeButton = document.querySelector('.close-btn');
      var viewDetailsButtons = document.querySelectorAll('.open-popup');
  
      viewDetailsButtons.forEach(function(button) {
          button.addEventListener('click', function(event) {
              event.preventDefault(); // Prevent the default action
  
              // Get the clicked row and its position
              var rect = this.closest('tr').getBoundingClientRect();
              var description = this.getAttribute('data-description');
              var creator = this.getAttribute('data-creater');
              // Set popup content and position
              document.getElementById('popup-description').innerHTML = `
              ${description} <br><br>
              <span style="color: c2c2c2; font-size:13px;">Opened by: ${creator}</span>
            `;
              popupContent.style.top = (rect.top + window.scrollY) + 'px';
              popupContent.style.left = (rect.left + window.scrollX) + 'px';
              popupContent.style.width = (rect.width) + 'px';
              
              // Show the popup
              popup.style.display = 'flex';
          });
      });
  
      closeButton.addEventListener('click', function() {
          popup.style.display = 'none'; // Hide the popup
      });
  
      window.addEventListener('click', function(event) {
          if (event.target === popup) {
              popup.style.display = 'none'; // Hide the popup if clicking outside of it
          }
      });
  });
  </>
  


{% endblock scripts %}
{% endblock content %}
