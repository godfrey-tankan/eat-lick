{% extends 'layouts/base.html' %}
{% load static %}

{% block content %}
<body>
    <header class="hero-section">
        <div class="overlay"></div>
        <div class="hero-content">
            <h1>Welcome to Web Support</h1>
            <p>Your reliable partner for all web-related support needs.</p>
            <a href="#contact" class="cta-button">Get Support Now</a>
        </div>
    </header>

    <section class="features-section">
        <h2>Our Services</h2>
        <div class="features-container">
            <div class="feature-box">
                <img src="{%static 'avatars/avatar.svg'%}" alt="Support">
                <h3>24/7 Support</h3>
                <p>We provide round-the-clock assistance to ensure your website runs smoothly.</p>
            </div>
            <div class="feature-box">
                <img src="{%static 'avatars/avatar.svg'%}" alt="Consultation">
                <h3>Consultation</h3>
                <p>Expert advice on how to improve your web presence and optimize performance.</p>
            </div>
            <div class="feature-box">
                <img src="{%static 'avatars/avatar.svg'%}" alt="Troubleshooting">
                <h3>Troubleshooting</h3>
                <p>Quick and efficient solutions to any web-related issues you encounter.</p>
            </div>
        </div>
    </section>
    <div id="chat-popup" class="chat-popup">
        <div class="chat-header">
            <span>Support Chat</span>
            <button class="close-btn" onclick="closeChat()">x</button>
        </div>
        <div class="chat-body">
            <div class="messages">
                <!-- Messages will be dynamically loaded here -->
            </div>
        </div>
        <div class="phone-input-section">
            <input type="text" id="phone-input" placeholder="Enter your phone number..." class="chat-input" />
            <button id="phone-submit-btn" class="send-btn">Submit</button>
        </div>
        <div class="chat-footer" style="display: none;">
            <input type="file" id="upload-file" class="upload-input" />
            <input type="text" id="chat-input" placeholder="Type a message..." class="chat-input" />
            <button id="send-btn" class="send-btn">Send</button>
        </div>
    </div>

    <section class="contact-section" id="contact">
        <button id="open-chat-btn" class="open-chat-btn">Contact Us</button>
        <p>Ready to get started? Reach out to us today!</p>
        <form class="contact-form">
            <input type="text" placeholder="Your Name" required>
            <input type="email" placeholder="Your Email" required>
            <textarea placeholder="Your Message" required></textarea>
            <button type="submit" class="contact-button">Send Message</button>
        </form>
    </section>

    <footer class="footer">
        <p>&copy; 2024 Web Support. All rights reserved.</p>
    </footer>
</body>
<script>
    document.getElementById('open-chat-btn').addEventListener('click', function () {
        document.getElementById('chat-popup').style.display = 'block';
    });
    
    function closeChat() {
        document.getElementById('chat-popup').style.display = 'none';
    }
    
    // Handle Phone Number Submission
    document.getElementById('phone-submit-btn').addEventListener('click', function () {
        let phoneNumber = document.getElementById('phone-input').value.trim();
        if (phoneNumber !== '') {
        const csrftoken = getCSRFToken();
        let phoneRegex = /^((07[1378]\d{7})|(263[1378]\d{8})|(\+263[1378]\d{8}))$/;

        if (!phoneRegex.test(phoneNumber)) {
            displayMessage('Please enter a valid phone number.', 'received');
            return; 
        }

        fetch('chat/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,  // Add this line
            },
            body: JSON.stringify({ phone: phoneNumber }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayMessage(data.message, 'received');
                document.querySelector('.chat-footer').style.display = 'flex';
                document.querySelector('.phone-input-section').style.display = 'none';
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => console.error('Error:', error));
        }
    });
    
    // Handle Chat Message Submission
    document.getElementById('send-btn').addEventListener('click', function () {
        let input = document.getElementById('chat-input');
        let message = input.value;
        if (message.trim() !== '') {
            displayMessage(message, 'sent');
            input.value = '';  // Clear the input
            scrollToBottom();  // Scroll to the latest message
        }
    });
    
    function displayMessage(message, type) {
        let messageElement = document.createElement('div');
        messageElement.classList.add('message', type);
        messageElement.innerText = message;
        document.querySelector('.messages').appendChild(messageElement);
        scrollToBottom();
    }

    function getCSRFToken() {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, 10) === ('csrftoken=')) {
                    cookieValue = decodeURIComponent(cookie.substring(10));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    function scrollToBottom() {
        let chatBody = document.querySelector('.chat-body');
        chatBody.scrollTop = chatBody.scrollHeight;
    }
</script>
</html>
