{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web support</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap">
</head>
<style>

    body {
        margin: 0;
        font-family: 'Montserrat', sans-serif;
        color: #333;
        line-height: 1.6;
    }
    header {
        background: #007bff;
        padding: 10px 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        color: #fff;
    }
    
    .hero-section {
        height: 100vh;
        background: url('https://www.svgrepo.com/svg/335496/support.svg') no-repeat center center/cover;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        color: #fff;
    }
    
    .overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        z-index: 1;
    }
    
    .hero-content {
        z-index: 2;
        text-align: center;
    }
    
    .hero-content h1 {
        font-size: 3em;
        margin-bottom: 20px;
    }
    
    .hero-content p {
        font-size: 1.2em;
        margin-bottom: 40px;
    }
    
    .cta-button {
        background: #007bff;
        color: #fff;
        padding: 15px 30px;
        text-decoration: none;
        border-radius: 30px;
        font-weight: bold;
        transition: background 0.3s ease;
    }
    
    .cta-button:hover {
        background: #0056b3;
    }
    
    .features-section {
        padding: 60px 20px;
        text-align: center;
        background-color: #f7f7f7;
    }
    
    .features-section h2 {
        font-size: 2.5em;
        margin-bottom: 40px;
    }
    
    .features-container {
        display: flex;
        justify-content: space-around;
        flex-wrap: wrap;
    }
    
    .feature-box {
        background: #fff;
        padding: 20px;
        margin: 10px;
        border-radius: 10px;
        width: 300px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease;
    }
    
    .feature-box img {
        max-width: 100%;
        border-radius: 10px;
        margin-bottom: 20px;
    }
    
    .feature-box:hover {
        transform: translateY(-10px);
    }
    
    .contact-section {
        padding: 60px 20px;
        background: #f9fafb;
        color: #000;
        text-align: center;
    }
    
    .contact-section h2 {
        font-size: 2.5em;
        margin-bottom: 20px;
    }
    
    .contact-section p {
        font-size: 1.2em;
        margin-bottom: 40px;
    }
    
    .contact-form {
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    
    .contact-form input, .contact-form textarea {
        width: 80%;
        padding: 15px;
        margin-bottom: 20px;
        border: none;
        border-radius: 10px;
    }
    
    .contact-form .contact-button {
        background: #fff;
        color: #007bff;
        padding: 15px 30px;
        border: none;
        border-radius: 30px;
        cursor: pointer;
        font-weight: bold;
    }
    
    .footer {
        background: #333;
        color: #fff;
        padding: 20px;
        text-align: center;
    }
    #chat-popup {
        display: none;
        position: fixed;
        bottom: 17px;
        right: 20px;
        width: 400px;
        height: 600px;
        background-color: #ffffff;
        box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
        border-radius: 10px;
        overflow: hidden;
        z-index: 9000;
    }
    @media (max-width: 768px) {
        #chat-popup {
            display: none;
            position: fixed;
            bottom: 17px;
            right: 20px;
            width: 90%;
            height: 70%;
            background-color: #ffffff;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            overflow: hidden;
            z-index: 9000;
        }
    }
    .chat-header {
        padding: 10px;
        background-color: #333;
        color: #fff;
        font-weight: bold;
        text-align: center;
        border-bottom: 1px solid #ccc;
        position: relative;
    }
    .phone-input-section{
        flex-grow: 1;
        padding: 10px;
        width:350px;
        position:fixed;
        bottom: 17px;
        border: 1px solid #ccc;
        border-radius: 5px;
        margin-right: -20px;
    }
    .phone-input-section input {
        padding: 10px;
        border: none;
        border-radius: 5px;
        margin-right: 5px;
    }
    .phone-input-section button {
        border: none;
        border-radius: 5px;
        margin-left: 250px;
    }
    
    .close-btn {
        position: absolute;
        right: 10px;
        padding: 5px;
        top: 10px;
        background: none;
        border: none;
        color: #fff;
        font-size: 20px;
        cursor: pointer;
    }
    
    .chat-body {
        padding: 10px;
        height: calc(100% - 100px);
        overflow-y: auto;
    }
    
    .messages {
        display: flex;
        flex-direction: column;
        padding-bottom: 15px;
    }
    
    .message {
        padding: 8px;
        margin-bottom: 5px;
        border-radius: 5px;
        max-width: max-content;
    }
    
    .message.sent {
        background-color: #DCF8C6;
        align-self: flex-end;
    }
    
    .message.received {
        background-color: #f1f0f0;
        align-self: flex-start;
    }
    
    .chat-footer {
        margin-top: -50px;
        padding: 10px;
        display: flex;
        align-items: center;
        border-top: 1px solid #ccc;
    }
    
    .upload-input {
        display: none;
    }
    
    .chat-input {
        flex-grow: 1;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        margin-right: 5px;
    }
    .phone-input{
        flex-grow: 1;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        margin-right: 5px;
    }
    
    .send-btn {
        background-color: #007bff;
        color: #fff;
        padding: 10px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }

    .phone-send-btn{
        background-color: #007bff;
        color: #fff;
        padding: 10px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }
    
    .open-chat-btn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: #007bff;
        color: #fff;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        z-index: 1000;
    }
    .logo {
        display: flex;
        align-items: center;
        height: 50px;
        width: 50px;
        font-size: 1.5em;
        font-weight: bold;
    }
    .logo img {
        height: 100%;
        width: 100%;
        
    }
    .chat-logo {
        height: 30px;
        width: 30px;
    }
    .chat-logo img {
        height: 100%;
        width: 100%;
        object-fit: cover;
        
    }

    .nav-links {
        display: flex;
        gap: 20px;
    }

    .nav-links a {
        color: #fff;
        text-decoration: none;
        font-weight: 600;
    }

    .nav-links a:hover {
        text-decoration: underline;
    }

    .cta-button {
        background: #fff;
        color: #007bff;
        padding: 10px 20px;
        border-radius: 5px;
        text-decoration: none;
        font-weight: bold;
        transition: background 0.3s ease;
    }

    .cta-button:hover {
        background: #f0f0f0;
    }

    @media (max-width: 768px) {
        .nav-links {
            display: none;
        }

        .cta-button {
            padding: 8px 16px;
        }

        .menu-toggle {
            display: block;
            font-size: 1.5em;
            cursor: pointer;
        }
    }

    @media (min-width: 769px) {
        .menu-toggle {
            display: none;
        }
    }

    .nav-links.show {
        display: flex;
        flex-direction: column;
        position: absolute;
        top: 60px;
        right: 20px;
        background: #333;
        padding: 10px;
        border-radius: 5px;
    }
    
</style>
<body>
    <header>
        <div class="logo">
            <img src="{%static 'avatars/support.svg'%}" alt="Support">
        </div>
        <nav class="nav-links">
            <a href="#services">Services</a>
            <a href="#about">About Us</a>
            <a href="#contact">Contact</a>
            <a href="#contact" >Request support</a>
        </nav>
        <div class="menu-toggle">â˜°</div>
    </header>
    <header class="hero-section">
        <div class="overlay"></div>
        <div class="hero-content">
            <h1>Welcome to Web-version Support</h1>
            <p>We promise to assist you as soon as we can </p>
            <a href='#contact' class="cta-button">Have an inquiry?</a>
        </div>
    </header>

    <section class="features-section">
        <h2>Other Methods To Get Support</h2>
        <div class="features-container">
            <div class="feature-box">
                <img src="{%static 'avatars/whatsapp-svgrepo-com.svg'%}" alt="Support">
                <h3>Whatsapp - +263 77 795 1000</h3>
                <p>Our Members are 24/7 Available to assist you</p>
            </div>
            <div class="feature-box">
                <img src="{%static 'avatars/email-svgrepo-com.svg'%}" alt="Consultation">
                <h3>Email - support@ict.com</h3>
                <p>Send Through Your enquiries to our email and we will assist you shortly.</p>
            </div>
            <div class="feature-box">
                <img src="{%static 'avatars/web-svgrepo-com .svg'%}" alt="Troubleshooting">
                <h3>Web tithehurster.co.zw</h3>
                <p>Get <a
                    >help</a> 
                    now</p>
            </div>
        </div>
    </section>
    <div id="chat-popup" class="chat-popup">
        <div class="chat-header">
            <div class="chat-logo">
                <img src="{%static 'avatars/support.svg'%}" alt="Support">
            </div>
            <span>Support Chat</span>
            <button class="close-btn" onclick="closeChat()">x</button>
        </div>
        <div class="chat-body">
            <div class="messages">
                <!-- Messages will be dynamically loaded here -->
            </div>
        </div>
        {% comment %} <div class="phone-input-section">
        </div> {% endcomment %}

        <div class="chat-footer" >
            <input type="text" id="phone-input" placeholder="Enter your phone number..." class="phone-input" />
            <button id="phone-submit-btn" class="phone-send-btn">Submit</button>
            <input type="file" style="display: none;" id="upload-file" class="upload-input" />
            <input type="text" style="display: none;" id="chat-input" placeholder="Type a message..." class="chat-input" />
            <button id="send-btn" style="display: none;" class="send-btn">Send</button>
        </div>
    </div>

    <section class="contact-section" id="contact">
        <button id="open-chat-btn" class="open-chat-btn">Contact Us</button>
        <p>Ready to get started? Reach out to us today!</p>
        <form class="contact-form">
            <input type="text" placeholder="Your Name" required>
            <input type="email" placeholder="Your Email" required>
            <textarea placeholder="Your Message" required></textarea>
            <button type="submit" class="contact-button">Send Message</button>
        </form>
    </section>

    <footer class="footer">
        <p>&copy; 2024 Web Support. All rights reserved.</p>
    </footer>
</body>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
    let ticketId = localStorage.getItem('ticketId');  // Replace with the actual ticket ID
    let fetchingInterval;
    document.getElementById('open-chat-btn').addEventListener('click', function () {
        document.getElementById('chat-popup').style.display = 'block';

    });
    document.querySelector('.menu-toggle').addEventListener('click', function() {
        document.querySelector('.nav-links').classList.toggle('show');
    });
    
    function closeChat() {
        document.getElementById('chat-popup').style.display = 'none';
        if (fetchingInterval) {
            clearInterval(fetchingInterval);
            fetchingInterval = null;
        }
    }
    
    // Handle Phone Number Submission
    document.getElementById('phone-submit-btn').addEventListener('click', function () {
        let phoneNumber = document.getElementById('phone-input').value.trim();
        if (phoneNumber !== '') {
        const csrftoken = getCSRFToken();
        let phoneRegex = /^((07[1378]\d{7})|(263[1378]\d{8})|(\+263[1378]\d{8}))$/;

        if (!phoneRegex.test(phoneNumber)) {
            displayMessage('Please enter a valid phone number.', 'received');
            return; 
        }
        localStorage.setItem('userPhoneNumber', phoneNumber);
        fetch('chat/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,  // Add this line
            },
            body: JSON.stringify({ phone: phoneNumber }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('phone-submit-btn').style.display = 'none';
                document.getElementById('phone-input').style.display = 'none';
                document.getElementById('chat-input').style.display = 'block';
                document.querySelector('.send-btn').style.display = 'block';
                displayMessage(data.message, 'received');
                
            } else {
                displayMessage(data.error, 'received');
            }
        })
        .catch(error => console.error('Error:', error));
        }
    });

    //SENDING MESSAGE
    document.getElementById('send-btn').addEventListener('click', function () {
        let input = document.getElementById('chat-input');
        
        let message = input.value;
        if (message.trim() !== '') {
            displayMessage(message, 'sent');
            input.value = '';  // Clear the input
            scrollToBottom();  
            phone=localStorage.getItem('userPhoneNumber');
            const csrftoken = getCSRFToken();
            fetch('chat/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken,  
                },
                body: JSON.stringify({ phone: phone, message: message }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayMessage(data.message, 'received');
                    const ticketIdMatch = data.message.match(/#(\d+)/);
                    if (ticketIdMatch) {
                        ticketId = ticketIdMatch[1]; 
                        localStorage.setItem('ticketId', ticketId);
                    }
                    if (!fetchingInterval) {
                        startFetchingMessages(ticketId); 
                    }
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => console.error('Error:', error));
        }
        else{
            return;
        }
    });
    
    function displayMessage(message, type) {
        let messageElement = document.createElement('div');
        messageElement.classList.add('message', type);
        messageElement.innerText = message;
        document.querySelector('.messages').appendChild(messageElement);
        scrollToBottom();
    }
    function fetchMessages(ticketId) {
        // Check if chat-popup is visible
        const chatPopup = document.getElementById('chat-popup');
        if (chatPopup.style.display === 'block') {
            fetch(`/ticket/${ticketId}/fetch-messages/`)
                .then(response => response.json())
                .then(data => {
                    const messagesContainer = document.querySelector('.messages');
                    messagesContainer.innerHTML = ''; // Clear existing messages
    
                    data.messages.forEach(messageData => {
                        const messageType = messageData.inquirer ? 'sent' : 'received';
                        displayMessage(`${messageData.username}: ${messageData.content}`, messageType);
                    });
                })
                .catch(error => console.error('Error fetching messages:', error));
        }
    }
    
    function startFetchingMessages(ticketId) {
        fetchMessages(ticketId);
        setInterval(() => fetchMessages(ticketId), 7000);
    }

    function getCSRFToken() {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, 10) === ('csrftoken=')) {
                    cookieValue = decodeURIComponent(cookie.substring(10));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    function scrollToBottom() {
        let chatBody = document.querySelector('.chat-body');
        chatBody.scrollTop = chatBody.scrollHeight;
    }
</script>
</html>
