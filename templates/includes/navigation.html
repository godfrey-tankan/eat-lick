{% load static %}
<!-- Navbar -->
<nav class="navbar navbar-main navbar-expand-lg px-0 mx-4 shadow-none border-radius-xl z-index-200" id="navbarBlur" navbar-scroll="true">
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>

  <div class="container-fluid py-1 px-3">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb bg-transparent mb-0 pb-0 pt-1 px-0 me-sm-6 me-5">
        <li class="breadcrumb-item text-sm"><a class="opacity-5 text-dark" href="/enlsupport">Home</a></li>
        <li class="text-sm text-dark active ms-2" aria-current="page">
          {% if request.path == '/enlsupport' %} / Dashboard {% else %} {{ request.path|title }} {% endif %}
        </li>
        <li class="text-sm text-dark active ms-4" aria-current="page">
          <a href="javascript:void(0);" id="create-branch-btn" class="unique-branch-popup-btn">+Branches</a>
        </li>
        
        <!-- Button to trigger +Ticket form -->
        <li class="text-sm text-dark active ms-4" aria-current="page">
            <a href="/inquiries/" id="show-ticket-form-btn" class="unique-ticket-popup-btn">Tickets</a>
        </li>
        
        <!-- Button to trigger +Inquirer form -->
        <li class="text-sm text-dark active ms-4" aria-current="page">
            <a href="/admins/home/inquirer/add/" id="create-inquirer-btn" class="unique-inquirer-popup-btn">+Inquirers</a>
        </li>

      </ol>
    </nav>
    <div class="collapse navbar-collapse mt-sm-0 mt-2 me-md-0 me-sm-4" id="navbar">
      <div class="ms-md-auto pe-md-3 d-flex align-items-center">
        <form action="{%url 'global_search'%}" method="get" class="d-flex">
          <div class="input-group">
              <span class="input-group-text text-body" style='z-index:200;'><i class='bx bx-search'></i></span>
              {% comment %} <input type="text" id="global-search-input" class="form-control" name="q" placeholder="Type here..." value="{{ query }}"> {% endcomment %}
              <input type="text" id="global-search-input" name="q" class="form-control" placeholder="Type here..." style='z-index:200;'>
          </div>
      </form>
      </div>
      <ul class="navbar-nav  justify-content-end">

        {% if request.user.is_authenticated %}
          <li class="nav-item d-flex align-items-center">

            {% if request.user.is_superuser %}
            <a href="{% url 'admin:logout' %}" class="nav-link text-body font-weight-bold px-0">
            {% else %}
            <a href="{% url 'logout' %}" class="nav-link text-body font-weight-bold px-0">
            {% endif %}
            
              <i class="bx b-user bx-sm"></i>
              <span class="d-sm-inline d-none me-3">Logout</span>
            </a>
            
          </li>
        {% else %}
          <li class="nav-item d-flex align-items-center">
            <a href="{% url 'login' %}" class="nav-link text-body font-weight-bold px-0">
              <i class="bx bx-user bx-sm"></i>
              <span class="d-sm-inline d-none me-3">Sign In</span>
            </a>
          </li>
        {% endif %}

        <li class="nav-item d-flex align-items-center">

          {% if request.user.is_superuser %}
          <a href="{% url 'admin:password_change' %}" class="nav-link text-body font-weight-bold px-0">
          {% else %}
          <a href="{% url 'password_change' %}" class="nav-link text-body font-weight-bold px-0">
          {% endif %}
            <span class="d-sm-inline d-none me-3">Change Password</span>
          </a>
        </li>

       <li class="nav-item d-xl-none ps-3 d-flex align-items-center">
          <a href="javascript:;" class="nav-link text-body p-0" id="iconNavbarSidenav">
            <div class="sidenav-toggler-inner">
              <i class="sidenav-toggler-line"></i>
              <i class="sidenav-toggler-line"></i>
              <i class="sidenav-toggler-line"></i>
            </div>
          </a>
        </li>
        <li class="nav-item px-3 d-flex align-items-center">
          <a href="javascript:;" class="nav-link text-body p-0">
            <i class="fa fa-cog fixed-plugin-button-nav cursor-pointer"></i>
          </a>
        </li>
       

        <li class="nav-item pe-2 d-flex align-items-center">
          <label for="theme-switch" class="nav-link text-body p-0 m-0">
            <i class="bx bx-sun fixed-plugin-button-nav cursor-pointer" id="theme-indicator"></i>
          </label>
          <input type="checkbox" class="d-none" id="theme-switch"/>
        </li>
      </ul>
    </div>
  </div>
</nav>
<script>
  document.getElementById('global-search-input').addEventListener('input', function() {
    let query = this.value.toLowerCase();

    // DOM Filtering
    let items = document.querySelectorAll('.searchable-item');
    items.forEach(function(item) {
        let text = item.textContent.toLowerCase();
        if (text.includes(query)) {
            item.style.display = ''; // Show the item
        } else {
            item.style.display = 'none'; // Hide the item
        }
    });

    // Backend Search via AJAX
    if (query.length > 2) { // Start searching on the backend after 3 characters
        fetch(`/search?q=${query}`)
            .then(response => response.text())
            .then(html => {
                // Replace the existing search results container with the new HTML
                document.getElementById('search-results').innerHTML = html;
            });
    }
});

</script>


{% comment %} // Popup shortcuts for creating new branches, tickets, and inquirers {% endcomment %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Close button functionality
    const closeButton = document.getElementById('close-branch-popup-btn');
    if (closeButton) {
        closeButton.addEventListener('click', function () {
            document.getElementById('unique-branch-popup').style.display = 'none';
        });
    }

    // Open popup and load branches when create button is clicked
    document.getElementById('create-branch-btn').addEventListener('click', function() {
        document.getElementById('unique-branch-popup').style.display = 'flex';
        loadBranches();  // Load existing branches when popup is opened
    });

    // Show the "Add New Branch" form when the button is clicked
    document.getElementById('show-add-branch-form').addEventListener('click', function() {
        document.getElementById('unique-branch-form').style.display = 'block';
        this.style.display = 'none'; // Hide the "Add New Branch" button after clicking
    });

    // Load Branches from the database (AJAX)
    function loadBranches() {
      fetch('/branches/')  // Fetch from the Django endpoint
          .then(response => response.json())
          .then(data => {
              const branches = data.branches;
              const branchListContainer = document.getElementById('branch-list');
              branchListContainer.innerHTML = '';  // Clear previous list
  
              branches.forEach(branch => {
                  const div = document.createElement('div');
                  div.classList.add('unique-list-item');
                  div.innerHTML = `
                      <span>${branch.name} (${branch.code})</span>
                      <div>
                          <button class="edit-branch-btn" data-branch-id="${branch.id}">Edit</button>
                          <button style="color:red" class="delete-branch-btn" data-branch-id="${branch.id}">Delete</button>
                      </div>
                  `;
                  branchListContainer.appendChild(div);
              });

              // Add event listeners to Edit buttons
              const editButtons = document.querySelectorAll('.edit-branch-btn');
              const deleteButtons = document.querySelectorAll('.delete-branch-btn');
              editButtons.forEach(button => {
                  button.addEventListener('click', function() {
                      const branchId = this.getAttribute('data-branch-id');
                      editBranch(branchId);
                  });
              });
              deleteButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const branchId = this.getAttribute('data-branch-id');
                    deleteBranch(branchId);
                });
            });
          });
    }

    // Add New Branch (AJAX)
    document.getElementById('unique-branch-form').addEventListener('submit', function(event) {
        event.preventDefault();
        const branchName = document.getElementById('branch-name').value;
        const branchCode = document.getElementById('branch-code').value;

        fetch('/branches/add/', {
            method: 'POST',
            body: new URLSearchParams({ 'name': branchName, 'code': branchCode })
        })
            .then(response => response.json())
            .then(data => {
                loadBranches(); // Reload branches
                resetBranchForm(); // Reset the form after adding
            });
    });
    // Function to filter branches
    function filterBranches() {
        const searchQuery = document.getElementById('branch-search').value.toLowerCase();
        const branches = document.getElementById('branch-list').getElementsByClassName('unique-list-item');
        
        // Loop through branches and show/hide based on search query
        for (let i = 0; i < branches.length; i++) {
            const branchName = branches[i].querySelector('span').innerText.toLowerCase();
            if (branchName.includes(searchQuery)) {
                branches[i].style.display = 'block';
            } else {
                branches[i].style.display = 'none';
            }
        }
    }

    // Add event listener to the search input
    const searchInput = document.getElementById('branch-search');
    if (searchInput) {
        searchInput.addEventListener('keyup', filterBranches);
    }

    // Edit branch
    function editBranch(branchId) {
        fetch(`/branches/update/${branchId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.branch) {
                    document.getElementById('branch-name').value = data.branch.name;
                    document.getElementById('branch-code').value = data.branch.code;

                    // Update the form to submit as "Edit"
                    document.getElementById('submit-branch').textContent = 'Update Branch';

                    // Bind the submit button to update the branch
                    document.getElementById('submit-branch').onclick = function(event) {
                        event.preventDefault();
                        updateBranch(branchId); // Call update function
                    };

                    // Show the form to update the branch
                    document.getElementById('unique-branch-form').style.display = 'block';
                    document.getElementById('show-add-branch-form').style.display = 'none'; // Hide the "Add New Branch" button
                }
            })
            .catch(error => {
                console.error('Error fetching branch details:', error);
            });
    }

    // Update Branch (AJAX)
    function updateBranch(branchId) {
        const branchName = document.getElementById('branch-name').value;
        const branchCode = document.getElementById('branch-code').value;

        fetch(`/branches/update/${branchId}/`, {
            method: 'POST',
            body: new URLSearchParams({ 'name': branchName, 'code': branchCode })
        })
            .then(response => response.json())
            .then(data => {
                loadBranches(); // Reload branches
                resetBranchForm(); // Reset the form after update
            });
    }

    // Delete Branch (AJAX)
    function deleteBranch(branchId) {
        fetch(`/branches/delete/${branchId}/`, {
            method: 'POST',
        })
            .then(response => response.json())
            .then(data => {
                loadBranches(); // Reload branches
            });
    }


    // Reset the form fields and text
    function resetBranchForm() {
        document.getElementById('branch-name').value = '';
        document.getElementById('branch-code').value = '';
        document.getElementById('submit-branch').textContent = 'Add New Branch';
        document.getElementById('unique-branch-form').style.display = 'none';
        document.getElementById('show-add-branch-form').style.display = 'block'; // Show the "Add New Branch" button again
    }

  });
</script>


<!-- End Navbar -->
